<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mathify ‚Äî Admin/Teacher Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@400;500;600;700&display=swap');

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0f172a;
      color: #f1f5f9;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      padding-top: 80px; /* Space for fixed header */
    }

    .header {
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      padding: 18px 40px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: white;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(148, 163, 184, 0.1);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .header-logo {
      height: 50px;
      width: 50px;
      border-radius: 50%;
      object-fit: cover;
      background: white;
      padding: 3px;
    }

    .header-welcome {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 2px;
    }

    .header-brand {
      font-size: 20px;
      font-weight: 700;
      margin: 0;
    }

    .header-greeting {
      font-size: 14px;
      font-weight: 400;
      opacity: 0.9;
      margin: 0;
    }

    .header-account {
      font-size: 16px;
      font-weight: 600;
      margin: 0;
    }

    .header-right {
      display: flex;
      align-items: center;
    }

    .header button {
      padding: 10px 24px;
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      color: #fca5a5;
      font-weight: 600;
      transition: all 0.3s;
      font-family: 'Inter', sans-serif;
    }

    .header button:hover {
      background: rgba(239, 68, 68, 0.25);
      border-color: rgba(239, 68, 68, 0.5);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);
    }

    @media (max-width: 768px) {
      .header {
        padding: 15px 20px;
      }

      .header-logo {
        height: 40px;
        width: 40px;
      }

      .header-brand {
        font-size: 18px;
      }

      .header-greeting {
        font-size: 12px;
      }

      .header-account {
        font-size: 14px;
      }
    }

    .main-container {
      display: flex;
      flex: 1;
      overflow: hidden;
      position: relative;
      z-index: 1;
    }

    /* Navigation Sidebar */
    .sidebar {
      width: 280px;
      background: #1e293b;
      border-right: 1px solid rgba(148, 163, 184, 0.1);
      padding: 0;
      overflow-y: auto;
      overflow-x: hidden;
      z-index: 10;
      height: calc(100vh - 80px);
      position: sticky;
      top: 80px;
      box-shadow: 4px 0 20px rgba(0,0,0,0.2);
    }

    .nav-item {
      padding: 16px 28px;
      cursor: pointer;
      transition: all 0.3s;
      border-left: 3px solid transparent;
      display: flex;
      align-items: center;
      gap: 14px;
      color: #cbd5e1;
      font-size: 15px;
      font-weight: 500;
      position: relative;
      font-family: 'Inter', sans-serif;
    }

    .nav-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: #6366f1;
      transform: scaleY(0);
      transition: transform 0.3s;
    }

    .nav-item:hover {
      background: rgba(99, 102, 241, 0.1);
      color: #f1f5f9;
    }

    .nav-item.active {
      background: rgba(99, 102, 241, 0.15);
      color: #6366f1;
      border-left-color: #6366f1;
      font-weight: 600;
    }

    .nav-item.active::before {
      transform: scaleY(1);
    }

    .nav-item-icon {
      font-size: 20px;
      width: 24px;
      text-align: center;
    }

    .content-area {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 32px;
      height: calc(100vh - 80px);
      background: #0f172a;
      position: relative;
    }

    .content-area::before {
      content: '';
      position: fixed;
      top: 80px;
      left: 280px;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(at 20% 30%, rgba(99, 102, 241, 0.08) 0px, transparent 50%),
        radial-gradient(at 80% 70%, rgba(139, 92, 246, 0.08) 0px, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }

    .page {
      display: none;
      animation: fadeIn 0.3s;
    }

    .page.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Child Profile Selector */
    .child-selector {
      background: rgba(30, 41, 59, 0.6);
      backdrop-filter: blur(10px);
      padding: 24px;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      border: 1px solid rgba(148, 163, 184, 0.1);
      margin-bottom: 30px;
      display: flex;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
      position: relative;
      z-index: 1;
    }

    .child-selector label {
      font-weight: 600;
      color: #6366f1;
      font-size: 15px;
      font-family: 'Inter', sans-serif;
    }

    .child-selector select {
      padding: 12px 16px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 10px;
      font-size: 15px;
      font-family: 'Inter', sans-serif;
      cursor: pointer;
      flex: 1;
      min-width: 200px;
      background: rgba(15, 23, 42, 0.5);
      color: #f1f5f9;
      transition: all 0.3s;
    }

    .child-selector select:focus {
      outline: none;
      border-color: #6366f1;
      background: rgba(15, 23, 42, 0.7);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
    }

    .child-selector select:hover {
      border-color: #6366f1;
    }

    .add-child-btn {
      padding: 12px 24px;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      transition: all 0.3s;
      font-family: 'Inter', sans-serif;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .add-child-btn:hover {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    }

    .add-child-btn:active {
      transform: translateY(0);
    }

    /* Reusable admin/teacher table + toolbar styles */
    .table-card {
      background: rgba(30, 41, 59, 0.6);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      border: 1px solid rgba(148, 163, 184, 0.1);
      margin-bottom: 24px;
      overflow: hidden;
      position: relative;
      z-index: 1;
    }

    .table-header {
      padding: 20px 28px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
      background: rgba(15, 23, 42, 0.3);
    }

    .table-header-title {
      font-size: 20px;
      font-weight: 700;
      color: #f1f5f9;
      display: flex;
      align-items: center;
      gap: 10px;
      font-family: 'Inter', sans-serif;
    }

    .table-header-subtitle {
      font-size: 14px;
      color: #94a3b8;
      font-weight: 500;
    }

    .table-toolbar {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .pill-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: #ebf4ff;
      color: #4c51bf;
      font-size: 12px;
      font-weight: 600;
    }

    .search-input {
      padding: 10px 16px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      background: rgba(15, 23, 42, 0.5);
      color: #f1f5f9;
      font-family: 'Inter', sans-serif;
      font-size: 14px;
      min-width: 200px;
      transition: all 0.3s;
    }

    .search-input::placeholder {
      color: #64748b;
    }

    .search-input:focus {
      outline: none;
      border-color: #6366f1;
      background: rgba(15, 23, 42, 0.7);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
    }

    .admin-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    .admin-table thead {
      background: rgba(15, 23, 42, 0.5);
    }

    .admin-table th,
    .admin-table td {
      padding: 16px 24px;
      text-align: left;
      border-bottom: 1px solid rgba(148, 163, 184, 0.1);
      white-space: nowrap;
    }

    .admin-table th {
      font-weight: 600;
      color: #cbd5e1;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-family: 'Inter', sans-serif;
    }

    .admin-table td {
      color: #e2e8f0;
    }

    .admin-table tbody tr:hover {
      background: rgba(99, 102, 241, 0.1);
    }

    .chip {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 10px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      margin-right: 6px;
      margin-bottom: 4px;
      background: rgba(99, 102, 241, 0.2);
      color: #818cf8;
      border: 1px solid rgba(99, 102, 241, 0.3);
      font-family: 'Inter', sans-serif;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      padding: 4px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      font-family: 'Inter', sans-serif;
    }

    .status-pill.success {
      background: rgba(16, 185, 129, 0.2);
      color: #6ee7b7;
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .status-pill.muted {
      background: rgba(148, 163, 184, 0.2);
      color: #94a3b8;
      border: 1px solid rgba(148, 163, 184, 0.3);
    }

    /* Toast notifications */
    .toast {
      position: fixed;
      right: 24px;
      bottom: 24px;
      padding: 12px 16px;
      border-radius: 12px;
      background: #2f855a;
      color: white;
      font-size: 14px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.25);
      display: none;
      align-items: center;
      gap: 8px;
      z-index: 1200;
    }

    .toast.show {
      display: inline-flex;
      animation: fadeInOut 3s ease forwards;
    }

    .toast.toast-error {
      background: #c53030;
    }

    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateY(10px); }
      10% { opacity: 1; transform: translateY(0); }
      90% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(10px); }
    }

    .add-child-btn:active {
      transform: translateY(0);
    }

    /* Grid Layouts */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .grid-3 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .card {
      background: rgba(30, 41, 59, 0.6);
      backdrop-filter: blur(10px);
      padding: 28px;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      border: 1px solid rgba(148, 163, 184, 0.1);
      transition: all 0.3s;
      position: relative;
      z-index: 1;
    }

    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(0,0,0,0.4);
      border-color: rgba(99, 102, 241, 0.3);
    }

    .card h3 {
      margin: 0 0 20px 0;
      color: #f1f5f9;
      font-size: 22px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 12px;
      font-family: 'Inter', sans-serif;
    }

    .card h4 {
      margin: 0 0 12px 0;
      color: #6366f1;
      font-size: 17px;
      font-weight: 600;
      font-family: 'Inter', sans-serif;
    }

    /* Child Overview Panel */
    .overview-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .stat-item {
      text-align: center;
      padding: 20px;
      background: rgba(30, 41, 59, 0.8);
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.1);
      transition: all 0.3s;
    }

    .stat-item:hover {
      background: rgba(30, 41, 59, 1);
      border-color: rgba(99, 102, 241, 0.3);
      transform: translateY(-2px);
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #6366f1;
      margin: 8px 0;
      font-family: 'Inter', sans-serif;
    }

    .stat-label {
      font-size: 13px;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 500;
    }

    /* AI Learning Summary */
    .ai-summary {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      color: white;
      padding: 28px;
      border-radius: 16px;
      margin-top: 30px;
      margin-bottom: 30px;
      box-shadow: 0 8px 32px rgba(99, 102, 241, 0.3);
      border: 1px solid rgba(139, 92, 246, 0.3);
      position: relative;
      z-index: 1;
    }

    .ai-summary h3 {
      color: white;
      margin-bottom: 15px;
    }

    .ai-summary-content {
      background: rgba(255,255,255,0.1);
      padding: 20px;
      border-radius: 10px;
      line-height: 1.6;
    }

    .ai-summary-item {
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }

    .ai-summary-item:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }

    .ai-summary-item strong {
      display: block;
      margin-bottom: 8px;
      font-size: 16px;
      opacity: 0.95;
    }

    .ai-summary-item p {
      margin: 0;
      opacity: 0.9;
      font-size: 14px;
    }

    /* Performance Graph */
    .chart-container {
      position: relative;
      height: 300px;
      margin-top: 15px;
    }

    /* Alerts and Notifications */
    .alert-item {
      padding: 16px;
      background: rgba(239, 68, 68, 0.1);
      border-left: 3px solid #f87171;
      border-radius: 12px;
      margin-bottom: 12px;
      display: flex;
      align-items: start;
      gap: 12px;
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .alert-item.warning {
      background: rgba(245, 158, 11, 0.1);
      border-left-color: #fbbf24;
      border-color: rgba(245, 158, 11, 0.2);
    }

    .alert-item.info {
      background: rgba(59, 130, 246, 0.1);
      border-left-color: #60a5fa;
      border-color: rgba(59, 130, 246, 0.2);
    }

    .alert-item.success {
      background: rgba(16, 185, 129, 0.1);
      border-left-color: #34d399;
      border-color: rgba(16, 185, 129, 0.2);
    }

    .alert-icon {
      font-size: 20px;
    }

    .alert-content {
      flex: 1;
    }

    .alert-title {
      font-weight: 600;
      margin-bottom: 6px;
      color: #f1f5f9;
      font-family: 'Inter', sans-serif;
    }

    .alert-message {
      font-size: 14px;
      color: #cbd5e1;
      line-height: 1.5;
    }

    .alert-time {
      font-size: 12px;
      color: #94a3b8;
      margin-top: 6px;
    }

    /* Rewards and Gamification */
    .rewards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .reward-badge {
      text-align: center;
      padding: 15px;
      background: #f7fafc;
      border-radius: 10px;
      border: 2px solid #e0e0e0;
      transition: all 0.3s;
    }

    .reward-badge.earned {
      border-color: #fbbf24;
      background: #fffbeb;
    }

    .reward-icon {
      font-size: 32px;
      margin-bottom: 5px;
    }

    .reward-name {
      font-size: 12px;
      color: #666;
      font-weight: 500;
    }

    .points-display {
      font-size: 24px;
      font-weight: 700;
      color: #f59e0b;
      text-align: center;
      margin: 15px 0;
    }

    /* Activity Monitoring */
    .activity-item {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 12px;
      background: #f7fafc;
      border-radius: 8px;
      margin-bottom: 10px;
    }

    .activity-icon {
      font-size: 24px;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #e6f3ff;
      border-radius: 50%;
    }

    .activity-details {
      flex: 1;
    }

    .activity-title {
      font-weight: 600;
      color: #333;
      margin-bottom: 3px;
    }

    .activity-time {
      font-size: 12px;
      color: #999;
    }

    .activity-duration {
      font-size: 14px;
      color: #5a67d8;
      font-weight: 500;
    }

    /* Curriculum Alignment */
    .curriculum-item {
      padding: 15px;
      background: #f7fafc;
      border-radius: 8px;
      margin-bottom: 10px;
      border-left: 4px solid #5a67d8;
    }

    .curriculum-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .curriculum-title {
      font-weight: 600;
      color: #333;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 10px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #5a67d8 0%, #667eea 100%);
      transition: width 0.3s;
    }

    .progress-text {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }

    /* Remedial Activities */
    .activity-card {
      padding: 18px;
      background: rgba(239, 68, 68, 0.1);
      border-left: 3px solid #f87171;
      border-radius: 12px;
      margin-bottom: 12px;
      border: 1px solid rgba(239, 68, 68, 0.2);
      transition: all 0.3s;
    }

    .activity-card:hover {
      background: rgba(239, 68, 68, 0.15);
      transform: translateX(4px);
    }

    .activity-card.suggested {
      background: rgba(16, 185, 129, 0.1);
      border-left-color: #34d399;
      border-color: rgba(16, 185, 129, 0.2);
    }

    .activity-card.suggested:hover {
      background: rgba(16, 185, 129, 0.15);
    }

    .activity-card .activity-title {
      font-weight: 600;
      color: #f1f5f9;
      margin-bottom: 8px;
      font-family: 'Inter', sans-serif;
    }

    .activity-description {
      font-size: 14px;
      color: #cbd5e1;
      margin-bottom: 12px;
      line-height: 1.5;
    }

    .activity-btn {
      padding: 10px 20px;
      background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
      font-family: 'Inter', sans-serif;
      box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
    }

    .activity-btn:hover {
      background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    }

    /* Parent Tips */
    .tip-item {
      padding: 18px;
      background: rgba(30, 41, 59, 0.6);
      border-radius: 12px;
      margin-bottom: 12px;
      border-left: 3px solid #34d399;
      border: 1px solid rgba(16, 185, 129, 0.2);
      transition: all 0.3s;
    }

    .tip-item:hover {
      background: rgba(30, 41, 59, 0.8);
      transform: translateX(4px);
    }

    .tip-title {
      font-weight: 600;
      color: #f1f5f9;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-family: 'Inter', sans-serif;
    }

    .tip-content {
      font-size: 14px;
      color: #cbd5e1;
      line-height: 1.6;
    }

    /* Profile Management */
    .profile-card {
      padding: 20px;
      background: white;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* Modal Styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: #1e293b;
      border-radius: 20px;
      padding: 35px;
      max-width: 550px;
      width: 90%;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      border: 1px solid rgba(148, 163, 184, 0.2);
      position: relative;
      animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-header h3 {
      margin: 0;
      color: #f1f5f9;
      font-size: 26px;
      font-weight: 700;
      font-family: 'Inter', sans-serif;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: #94a3b8;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.3s;
    }

    .modal-close:hover {
      background: rgba(239, 68, 68, 0.2);
      color: #f87171;
    }

    .modal-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .modal-form input,
    .modal-form select {
      padding: 14px 16px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      border-radius: 10px;
      font-size: 16px;
      font-family: 'Inter', sans-serif;
      transition: all 0.3s;
      background: rgba(15, 23, 42, 0.5);
      color: #f1f5f9;
    }

    .modal-form input::placeholder {
      color: #64748b;
    }

    .modal-form input:focus,
    .modal-form select:focus {
      outline: none;
      border-color: #6366f1;
      background: rgba(15, 23, 42, 0.7);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
    }

    .modal-form input:hover,
    .modal-form select:hover {
      border-color: #6366f1;
    }

    .modal-form .password-wrapper {
      position: relative;
    }

    .modal-form .password-wrapper input {
      width: 100%;
      padding-right: 45px;
    }

    .modal-form .password-toggle {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      font-size: 20px;
      color: #666;
    }

    .modal-error {
      color: #fc8181;
      font-size: 14px;
      margin-top: -10px;
      display: none;
    }

    .modal-error.show {
      display: block;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .modal-btn {
      flex: 1;
      padding: 14px 20px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      font-family: 'Fredoka', sans-serif;
      transition: all 0.3s;
      transition: all 0.3s;
      font-family: 'Fredoka', sans-serif;
    }

    .modal-btn-primary {
      background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
      font-family: 'Inter', sans-serif;
    }

    .modal-btn-primary:hover {
      background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4);
    }

    .modal-btn-primary:active {
      transform: translateY(0);
    }

    .modal-btn-secondary {
      background: rgba(15, 23, 42, 0.5);
      color: #cbd5e1;
      border: 1px solid rgba(148, 163, 184, 0.2);
      font-family: 'Inter', sans-serif;
    }

    .modal-btn-secondary:hover {
      background: rgba(15, 23, 42, 0.7);
      border-color: rgba(148, 163, 184, 0.4);
      color: #f1f5f9;
    }

    .profile-info {
      flex: 1;
    }

    .profile-name {
      font-size: 20px;
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
    }

    .profile-details {
      font-size: 14px;
      color: #666;
    }

    .profile-actions {
      display: flex;
      gap: 10px;
    }

    .profile-btn {
      padding: 8px 15px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s;
    }

    .profile-btn.edit {
      background: #5a67d8;
      color: white;
    }

    .profile-btn.delete {
      background: #fc8181;
      color: white;
    }

    .profile-btn:hover {
      opacity: 0.8;
    }

    /* Responsive */
    @media (max-width: 768px) {
      body {
        padding-top: 70px; /* Smaller padding for mobile */
      }

      .main-container {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        display: flex;
        overflow-x: auto;
        padding: 10px 0;
      }

      .nav-item {
        white-space: nowrap;
        padding: 10px 15px;
        border-left: none;
        border-bottom: 4px solid transparent;
      }

      .nav-item.active {
        border-left: none;
        border-bottom-color: #5a67d8;
      }

      .grid, .grid-2, .grid-3 {
        grid-template-columns: 1fr;
      }
      
      .header {
        padding: 12px 20px;
      }
      
      .content-area {
        padding: 20px;
      }

      .sidebar {
        width: 100%;
        height: auto;
        position: relative;
        top: 0;
        display: flex;
        overflow-x: auto;
        padding: 10px 0;
        border-right: none;
        border-bottom: 1px solid rgba(148, 163, 184, 0.1);
      }

      .content-area::before {
        left: 0;
      }
    }
    /* Math Rain Animation */
    .math-rain {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }

    .math-rain span {
      position: absolute;
      top: -20%;
      font-size: clamp(2rem, 4vw, 3rem);
      color: rgba(90, 103, 216, 0.15);
      animation: fall 12s linear infinite;
      text-shadow: 0 4px 12px rgba(0,0,0,0.1);
      opacity: 0;
      filter: drop-shadow(0 6px 14px rgba(0,0,0,0.15));
    }

    .math-rain span:nth-child(odd) { animation-duration: 11s; }
    .math-rain span:nth-child(even) { animation-duration: 16s; }
    .math-rain span:nth-child(1) { left: 2%; animation-delay: -1s; }
    .math-rain span:nth-child(2) { left: 8%; animation-delay: -6s; }
    .math-rain span:nth-child(3) { left: 14%; animation-delay: -2s; }
    .math-rain span:nth-child(4) { left: 20%; animation-delay: -7s; }
    .math-rain span:nth-child(5) { left: 28%; animation-delay: -3s; }
    .math-rain span:nth-child(6) { left: 34%; animation-delay: -8s; }
    .math-rain span:nth-child(7) { left: 40%; animation-delay: -4s; }
    .math-rain span:nth-child(8) { left: 46%; animation-delay: -9s; }
    .math-rain span:nth-child(9) { left: 52%; animation-delay: -5s; }
    .math-rain span:nth-child(10) { left: 58%; animation-delay: -10s; }
    .math-rain span:nth-child(11) { left: 64%; animation-delay: -6s; }
    .math-rain span:nth-child(12) { left: 70%; animation-delay: -11s; }
    .math-rain span:nth-child(13) { left: 76%; animation-delay: -7s; }
    .math-rain span:nth-child(14) { left: 82%; animation-delay: -12s; }
    .math-rain span:nth-child(15) { left: 88%; animation-delay: -8s; }
    .math-rain span:nth-child(16) { left: 94%; animation-delay: -13s; }

    @keyframes fall {
      0% { transform: translate3d(0, -150vh, 0); opacity: 0; }
      8% { opacity: 1; }
      85% { opacity: 1; }
      92% { transform: translate3d(-24px, 80vh, 0); opacity: 1; }
      100% { transform: translate3d(-40px, 140vh, 0); opacity: 0; }
    }

  </style>
</head>
<body>

  <!-- Math Rain Animation -->
  <div class="math-rain" aria-hidden="true">
    <span>+</span>
    <span>=</span>
    <span>√ó</span>
    <span>√∑</span>
    <span>+</span>
    <span>=</span>
    <span>√ó</span>
    <span>√∑</span>
    <span>+</span>
    <span>=</span>
    <span>√ó</span>
    <span>√∑</span>
    <span>+</span>
    <span>=</span>
    <span>√ó</span>
    <span>√∑</span>
  </div>

  <div class="header">
    <div class="header-left">
      <img src="../assets/Mathify Logo.png" alt="Mathify Logo" class="header-logo">
      <div class="header-welcome">
        <p class="header-brand">Mathify</p>
        <p class="header-greeting">Welcome!</p>
        <p class="header-account" id="accountName">Loading...</p>
      </div>
    </div>
    <div class="header-right">
      <button onclick="handleLogout()">Logout</button>
    </div>
  </div>

  <!-- Global toast notification -->
  <div id="globalToast" class="toast">
    <span id="globalToastIcon">‚úÖ</span>
    <span id="globalToastMessage"></span>
  </div>

  <div class="main-container">
    <!-- Navigation Sidebar -->
    <div class="sidebar">
      <div class="nav-item active" onclick="showPage('page1')">
        <span class="nav-item-icon">üè†</span>
        <span>Home</span>
      </div>
      <div class="nav-item" onclick="showPage('page2')">
        <span class="nav-item-icon">üìä</span>
        <span>Progress & Analytics</span>
      </div>
      <div class="nav-item" onclick="showPage('page3')">
        <span class="nav-item-icon">üí°</span>
        <span>Learning Insights</span>
      </div>
      <div class="nav-item" onclick="showPage('page4')">
        <span class="nav-item-icon">üèÜ</span>
        <span>Rewards</span>
      </div>
      <div class="nav-item" onclick="showPage('page5')">
        <span class="nav-item-icon">üë•</span>
        <span>Students</span>
      </div>
      <div class="nav-item" onclick="showPage('page6')">
        <span class="nav-item-icon">üë©‚Äçüè´</span>
        <span>Teachers</span>
      </div>
      <div class="nav-item" onclick="showPage('page7')">
        <span class="nav-item-icon">üìö</span>
        <span>Teacher Resources</span>
      </div>
      <div class="nav-item" onclick="showPage('page8')">
        <span class="nav-item-icon">‚ùì</span>
        <span>Dashboard Guide</span>
      </div>
    </div>

    <!-- Content Area -->
    <div class="content-area">
      <!-- Page 1: Home / Overview -->
      <div id="page1" class="page active">
        <div class="container">

          <!-- Student Selector + Grade Filter (only on Home page) -->
            <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap; margin-bottom: 24px;">
            <div style="display: flex; gap: 10px; align-items: center; flex-shrink: 0; min-width: 220px;">
              <label for="gradeFilterTop" style="font-weight: 600; color: #6366f1; font-size: 15px; white-space: nowrap; margin: 0; display: flex; align-items: center; font-family: 'Inter', sans-serif;">üìö Filter by Grade:</label>
              <select id="gradeFilterTop" onchange="loadStudents()" style="padding: 12px 16px; border-radius: 10px; border: 1px solid rgba(148, 163, 184, 0.2); font-family: 'Inter', sans-serif; font-size: 15px; background: rgba(15, 23, 42, 0.5); color: #f1f5f9; cursor: pointer; transition: all 0.3s; min-width: 140px; box-sizing: border-box; margin: 0;">
                <option value="">All Grades</option>
                <option value="1">Grade 1</option>
                <option value="2">Grade 2</option>
                <option value="3">Grade 3</option>
                <option value="4">Grade 4</option>
                <option value="5">Grade 5</option>
                <option value="6">Grade 6</option>
              </select>
            </div>
            <div style="display: flex; gap: 10px; align-items: center; flex: 1; min-width: 260px; max-width: 520px;">
              <label for="childSelect" style="font-weight: 600; color: #6366f1; font-size: 15px; white-space: nowrap; margin: 0; display: flex; align-items: center; font-family: 'Inter', sans-serif;">üë§ Select Student:</label>
              <select id="childSelect" onchange="loadChildData()" style="padding: 12px 16px; border-radius: 10px; border: 1px solid rgba(148, 163, 184, 0.2); font-family: 'Inter', sans-serif; font-size: 15px; background: rgba(15, 23, 42, 0.5); color: #f1f5f9; cursor: pointer; transition: all 0.3s; flex: 1; min-width: 200px; box-sizing: border-box; margin: 0;">
                <option value="">-- Select a student --</option>
              </select>
            </div>
            <button id="topCreateStudentBtn" class="add-child-btn" onclick="showAddStudentModal()" style="padding: 0 24px; background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 15px; font-weight: 600; transition: all 0.3s; box-shadow: 0 2px 8px rgba(72, 187, 120, 0.3); white-space: nowrap; height: 42px; display: flex; align-items: center; justify-content: center; margin: 0; flex-shrink: 0;">
              ‚ûï Create Account
            </button>
          </div>

          <!-- Child Overview Panel -->
          <div class="card">
            <h3>üìä Student Overview</h3>
            <div id="studentOverview">
              <p style="color: #94a3b8; text-align: center; padding: 40px;">
                Please select a student to view their progress.
              </p>
            </div>
          </div>

          <!-- AI-Generated Learning Summary -->
          <div class="ai-summary">
            <h3>ü§ñ AI-Generated Learning Summary</h3>
            <div id="aiSummaryContent" class="ai-summary-content">
              <p style="text-align: center; opacity: 0.8;">
                Select a student to view their personalized learning insights.
              </p>
            </div>
          </div>

          <!-- Alerts and Notifications -->
          <div class="card">
            <h3>üîî Alerts and Notifications</h3>
            <div id="alertsContainer">
              <p style="color: #94a3b8; text-align: center; padding: 20px;">
                No alerts at this time. Select a student to view their notifications.
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Page 2: Progress & Analytics -->
      <div id="page2" class="page">
        <div class="container">
          <div id="page2Content"></div>
          <!-- Performance Graphs -->
          <div class="grid-2">
            <div class="card">
              <h3>üìà Performance Over Time</h3>
              <div class="chart-container">
                <canvas id="performanceChart"></canvas>
              </div>
            </div>
            <div class="card">
              <h3>üìä Subject Breakdown</h3>
              <div class="chart-container">
                <canvas id="subjectChart"></canvas>
              </div>
            </div>
          </div>

          <!-- Activity and Engagement Monitoring -->
          <div class="card">
            <h3>üì± Activity and Engagement</h3>
            <h4>Recent Activity</h4>
            <div id="activityContainer">
              <p style="color: #666; text-align: center; padding: 20px;">Select a student to view their activity.</p>
            </div>
            <h4 style="margin-top: 20px;">Weekly Engagement</h4>
            <div class="chart-container" style="height: 200px;">
              <canvas id="engagementChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Page 3: Learning Insights -->
      <div id="page3" class="page">
        <div class="container">
          <!-- Curriculum Alignment View -->
          <div class="card">
            <h3>üìã Curriculum Alignment</h3>
            <div id="curriculumContainer">
              <p style="color: #666; text-align: center; padding: 40px;">Select a student to view their curriculum progress.</p>
            </div>
          </div>

          <!-- Remedial and Suggested Activities -->
          <div class="grid-2" style="margin-top: 30px;">
            <div class="card">
              <h3>üîß Remedial Activities</h3>
              <div id="remedialContainer">
                <p style="color: #666; text-align: center; padding: 20px;">Select a student to view recommended remedial activities.</p>
              </div>
            </div>
            <div class="card">
              <h3>üí° Suggested Activities</h3>
              <div id="suggestedContainer">
                <p style="color: #666; text-align: center; padding: 20px;">Select a student to view suggested activities.</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Page 4: Rewards & Motivation -->
      <div id="page4" class="page">
        <div class="container">
          <!-- Rewards and Gamification Tracking -->
          <div class="card">
            <h3>üèÜ Rewards and Gamification</h3>
            <div id="rewardsDisplay">
              <p style="color: #666; text-align: center; padding: 40px;">Select a student to view their rewards and achievements.</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Page 5: Manage Profiles -->
      <div id="page5" class="page">
        <div class="container">
          <!-- Student Profiles as compact table -->
          <div class="table-card">
            <div class="table-header">
              <div>
                <div class="table-header-title">üë• Manage Student Profiles</div>
                <div class="table-header-subtitle" id="studentScopeLabel">All students in the system.</div>
              </div>
              <div class="table-toolbar">
                <span class="pill-badge" id="roleBadge">Role: Admin</span>
                <select id="gradeFilterPage5" onchange="loadStudents()" style="padding: 10px 16px; border-radius: 10px; border: 1px solid rgba(148, 163, 184, 0.2); font-family: 'Inter', sans-serif; font-size: 14px; min-width: 150px; background: rgba(15, 23, 42, 0.5); color: #f1f5f9;">
                  <option value="">All Grades</option>
                  <option value="1">Grade 1</option>
                  <option value="2">Grade 2</option>
                  <option value="3">Grade 3</option>
                  <option value="4">Grade 4</option>
                  <option value="5">Grade 5</option>
                  <option value="6">Grade 6</option>
              </select>
                <input id="studentSearch" class="search-input" type="text" placeholder="Search by name or email" oninput="loadStudents()" />
                <button id="createStudentAccountBtn" class="add-child-btn" onclick="showAddStudentModal()">
                  ‚ûï Create Account
                </button>
            </div>
            </div>
            <div style="padding: 0 0 4px 0; overflow-x: auto;">
              <table class="admin-table" id="studentsTable">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Grade</th>
                    <th>Email</th>
                    <th>Created</th>
                    <th>Type</th>
                  </tr>
                </thead>
                <tbody id="profilesList">
                  <!-- Student profiles will be rendered here -->
                </tbody>
              </table>
              <div id="studentsEmptyState" style="padding: 20px; text-align: center; color: #94a3b8; display: none;">
                No students found for this view.
              </div>
            </div>

            <!-- Add Student Account Modal -->
            <div id="addStudentModal" class="modal-overlay">
              <div class="modal">
                <div class="modal-header">
                  <h3>Create New Student Account</h3>
                  <button class="modal-close" onclick="closeAddStudentModal()">&times;</button>
                </div>
                <form class="modal-form" onsubmit="handleAddAccount(event)">
                  <input type="text" id="modalStudentName" placeholder="Full Name" required />
                  <input type="email" id="modalStudentEmail" placeholder="Email" required />
                  <div class="password-wrapper">
                    <input type="password" id="modalStudentPassword" placeholder="Password" required />
                    <button type="button" class="password-toggle" onclick="toggleModalPassword('modalStudentPassword')">üôà</button>
                  </div>
                  <div id="modalGradeWrapper">
                    <select id="modalStudentGrade">
                    <option value="">Select Grade</option>
                    <option value="1">Grade 1</option>
                    <option value="2">Grade 2</option>
                    <option value="3">Grade 3</option>
                    <option value="4">Grade 4</option>
                    <option value="5">Grade 5</option>
                    <option value="6">Grade 6</option>
                  </select>
                  </div>
                  <div id="modalError" class="modal-error"></div>
                  <div class="modal-actions">
                    <button type="button" class="modal-btn modal-btn-secondary" onclick="closeAddStudentModal()">Cancel</button>
                    <button type="submit" class="modal-btn modal-btn-primary">Create Account</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Page 6: Teachers -->
      <div id="page6" class="page">
        <div class="container">
          <div class="table-card">
            <div class="table-header">
              <div>
                <div class="table-header-title">üë©‚Äçüè´ Teacher Accounts</div>
                <div class="table-header-subtitle">Manage all teacher accounts and their grade assignments.</div>
              </div>
              <div class="table-toolbar">
                <label style="font-weight: 600; color: #6366f1; font-size: 14px; font-family: 'Inter', sans-serif;">
                  üìö Grade taught:
                  <select id="teacherGradeFilter" onchange="loadTeachers()" style="margin-left: 6px; padding: 10px 16px; border-radius: 10px; border: 1px solid rgba(148, 163, 184, 0.2); font-family: 'Inter', sans-serif; font-size: 14px; background: rgba(15, 23, 42, 0.5); color: #f1f5f9;">
                    <option value="">All Grades</option>
                    <option value="1">Grade 1</option>
                    <option value="2">Grade 2</option>
                    <option value="3">Grade 3</option>
                    <option value="4">Grade 4</option>
                    <option value="5">Grade 5</option>
                    <option value="6">Grade 6</option>
                  </select>
                </label>
                <button class="add-child-btn" onclick="showAddTeacherModal()">
                  ‚ûï Create Teacher Account
                </button>
              </div>
            </div>

            <div style="padding: 0 0 4px 0; overflow-x: auto;">
              <table class="admin-table" id="teachersTable">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Grades Taught</th>
                    <th>Created</th>
                  </tr>
                </thead>
                <tbody id="teachersList">
                  <!-- Teacher accounts will be loaded here -->
                </tbody>
              </table>
              <div id="teachersEmptyState" style="padding: 20px; text-align: center; color: #94a3b8; display: none;">
                No teachers found for this filter.
              </div>
            </div>

            <!-- Add Teacher Account Modal -->
            <div id="addTeacherModal" class="modal-overlay">
              <div class="modal">
                <div class="modal-header">
                  <h3>Create New Teacher Account</h3>
                  <button class="modal-close" onclick="closeAddTeacherModal()">&times;</button>
                </div>
                <form class="modal-form" onsubmit="handleAddTeacherAccount(event)">
                  <input type="text" id="modalTeacherName" placeholder="Full Name" required />
                  <input type="email" id="modalTeacherEmail" placeholder="Email" required />
                  <div class="password-wrapper">
                    <input type="password" id="modalTeacherPassword" placeholder="Password" required />
                    <button type="button" class="password-toggle" onclick="toggleModalPassword('modalTeacherPassword')">üôà</button>
                  </div>
                  <div id="modalTeacherGradesWrapper">
                    <label style="font-weight: 600; color: #cbd5e1; margin-bottom: 8px; display: block; font-family: 'Inter', sans-serif;">Grade Levels Taught (select one or more)</label>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                      <label style="display: flex; align-items: center; gap: 6px;">
                        <input type="checkbox" class="teacher-grade-checkbox" value="1" /> Grade 1
                      </label>
                      <label style="display: flex; align-items: center; gap: 6px;">
                        <input type="checkbox" class="teacher-grade-checkbox" value="2" /> Grade 2
                      </label>
                      <label style="display: flex; align-items: center; gap: 6px;">
                        <input type="checkbox" class="teacher-grade-checkbox" value="3" /> Grade 3
                      </label>
                      <label style="display: flex; align-items: center; gap: 6px;">
                        <input type="checkbox" class="teacher-grade-checkbox" value="4" /> Grade 4
                      </label>
                      <label style="display: flex; align-items: center; gap: 6px;">
                        <input type="checkbox" class="teacher-grade-checkbox" value="5" /> Grade 5
                      </label>
                      <label style="display: flex; align-items: center; gap: 6px;">
                        <input type="checkbox" class="teacher-grade-checkbox" value="6" /> Grade 6
                      </label>
                    </div>
                  </div>
                  <div id="teacherModalError" class="modal-error"></div>
                  <div class="modal-actions">
                    <button type="button" class="modal-btn modal-btn-secondary" onclick="closeAddTeacherModal()">Cancel</button>
                    <button type="submit" class="modal-btn modal-btn-primary">Create Teacher</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Page 7: Teacher Resources -->
      <div id="page7" class="page">
        <div class="container">
          <!-- Teaching Tips Section -->
          <div class="card">
            <h3>üí¨ Teaching Tips & Resources</h3>
            <div id="tipsContainer">
              <div class="tip-item">
                <div class="tip-title">
                  <span>üí°</span>
                  <span>Encourage Daily Practice</span>
                </div>
                <div class="tip-content">
                  Consistent daily practice, even for just 15-20 minutes, helps reinforce learning and build confidence. Set a regular time each day for math practice.
                </div>
              </div>
              <div class="tip-item">
                <div class="tip-title">
                  <span>üéØ</span>
                  <span>Celebrate Small Wins</span>
                </div>
                <div class="tip-content">
                  Acknowledge progress and effort, not just perfect scores. Celebrating improvement motivates students to keep learning and trying their best.
                </div>
              </div>
              <div class="tip-item">
                <div class="tip-title">
                  <span>üìö</span>
                  <span>Connect Math to Real Life</span>
                </div>
                <div class="tip-content">
                  Help students see math in everyday activities like cooking, shopping, or measuring. This makes math more relevant and interesting.
                </div>
              </div>
              <div class="tip-item">
                <div class="tip-title">
                  <span>‚è∞</span>
                  <span>Create a Learning Routine</span>
                </div>
                <div class="tip-content">
                  Establish a consistent study routine. Students thrive with structure, and a regular schedule helps them develop good study habits.
                </div>
              </div>
              <div class="tip-item">
                <div class="tip-title">
                  <span>ü§ù</span>
                  <span>Be Patient and Supportive</span>
                </div>
                <div class="tip-content">
                  Learning math can be challenging. Be patient when students struggle, and offer encouragement. Focus on effort and progress rather than perfection.
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Page 8: Dashboard Guide -->
      <div id="page8" class="page">
        <div class="container">
          <div class="card">
            <h3>‚ùì How to Use This Dashboard</h3>
            <div style="text-align: center; padding: 40px 30px; background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%); border-radius: 12px; border: 2px dashed #cbd5e0;">
              <div style="font-size: 64px; margin-bottom: 20px;">üë•</div>
              <h3 style="color: #2d3748; font-size: 24px; margin-bottom: 12px; font-weight: 600;">Welcome to Mathify Dashboard</h3>
              <p style="color: #718096; font-size: 16px; margin-bottom: 30px; max-width: 600px; margin-left: auto; margin-right: auto;">
                Use this page as a quick guide for admins and teachers on how to manage accounts, filter students by grade, and read the analytics.
              </p>
              <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; margin-top: 30px;">
                <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); min-width: 180px;">
                  <div style="font-size: 32px; margin-bottom: 8px;">üìö</div>
                  <div style="font-weight: 600; color: #5a67d8; margin-bottom: 4px;">Filter Students</div>
                  <div style="font-size: 14px; color: #718096;">Use the ‚ÄúFilter by Grade‚Äù dropdown at the top to narrow students by grade level.</div>
                </div>
                <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); min-width: 180px;">
                  <div style="font-size: 32px; margin-bottom: 8px;">‚ûï</div>
                  <div style="font-weight: 600; color: #48bb78; margin-bottom: 4px;">Create Accounts</div>
                  <div style="font-size: 14px; color: #718096;">Click ‚ÄúCreate Account‚Äù to add new teacher or student accounts and assign the correct grade.</div>
                </div>
                <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); min-width: 180px;">
                  <div style="font-size: 32px; margin-bottom: 8px;">üìä</div>
                  <div style="font-weight: 600; color: #667eea; margin-bottom: 4px;">View Analytics</div>
                  <div style="font-size: 14px; color: #718096;">Use the Progress & Analytics and Learning Insights pages to track student performance.</div>
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <h3>ü§ñ AI Insights & Alerts</h3>
            <div class="ai-summary">
              <div id="aiSummaryGuide" class="ai-summary-content">
                <div style="text-align: center; padding: 40px 30px; opacity: 0.9;">
                  <div style="font-size: 48px; margin-bottom: 15px;">ü§ñ</div>
                  <h4 style="color: rgba(255,255,255,0.95); font-size: 20px; margin-bottom: 10px; font-weight: 600;">AI-Powered Insights</h4>
                  <p style="color: rgba(255,255,255,0.85); font-size: 15px; line-height: 1.6; max-width: 600px; margin: 0 auto;">
                    When a student is selected, the AI analyzes their activity to highlight strengths, gaps, and recommended topics. Use these insights to plan targeted practice and interventions.
                  </p>
                </div>
              </div>
            </div>
            <div style="margin-top: 20px; padding: 24px; background: #fffbf0; border-radius: 10px; border: 2px solid #fef3c7; text-align: center;">
              <div style="font-size: 40px; margin-bottom: 10px;">üîî</div>
              <h4 style="color: #92400e; font-size: 18px; margin-bottom: 8px; font-weight: 600;">Alerts and Notifications</h4>
              <p style="color: #78350f; font-size: 14px; max-width: 600px; margin: 0 auto;">
                Alerts appear when students need support‚Äîfor example, repeated low scores or long periods of inactivity. Check this regularly to see which students need attention.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Page Navigation
    function showPage(pageId) {
      // Hide all pages
      document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
      });
      
      // Remove active class from all nav items
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      
      // Show selected page
      document.getElementById(pageId).classList.add('active');
      
      // Add active class to clicked nav item
      event.currentTarget.classList.add('active');
      
      // Initialize charts if on page 2
      if (pageId === 'page2') {
        setTimeout(() => {
          initCharts();
        }, 100);
      }
      
      // Load students if on page 5
      if (pageId === 'page5') {
        loadStudents();
      }
      if (pageId === 'page6') {
        loadTeachers();
      }
      
      // Load real data when switching to analytics/insights pages
      if (pageId === 'page2' && selectedStudent) {
        setTimeout(() => {
          initCharts();
          loadActivityTimeline(selectedStudent);
        }, 100);
      }
      
      if (pageId === 'page3' && selectedStudent) {
        setTimeout(() => {
          loadCurriculumProgress(selectedStudent);
          loadRemedialActivities(selectedStudent);
        }, 100);
      }
      
      if (pageId === 'page4' && selectedStudent) {
        setTimeout(() => {
          loadStudentRewards(selectedStudent);
        }, 100);
      }
    }

    // Initialize Charts with REAL DATA
    let performanceChart, subjectChart, engagementChart;

    async function initCharts() {
      if (!selectedStudent) {
        // Show placeholder if no student selected
        return;
      }
      
      // Destroy existing charts if they exist
      if (performanceChart) performanceChart.destroy();
      if (subjectChart) subjectChart.destroy();
      if (engagementChart) engagementChart.destroy();

      try {
        // Load real data
        const sessionsResult = await window.electronAPI.invoke('get-practice-sessions', selectedStudent.id);
        const topicProgressResult = await window.electronAPI.invoke('get-student-topic-progress', selectedStudent.id, selectedStudent.grade);
        const curriculumResult = await window.electronAPI.invoke('get-curriculum-topics', selectedStudent.grade);
        
        const sessions = sessionsResult.success ? (sessionsResult.sessions || []) : [];
        const topicProgress = topicProgressResult.success ? (topicProgressResult.progress || []) : [];
        const topics = curriculumResult.success ? (curriculumResult.topics || []) : [];
        
        // Performance Over Time Chart - Use last 6 sessions
        const performanceCtx = document.getElementById('performanceChart');
        if (performanceCtx) {
          const recentSessions = sessions.slice(0, 6).reverse();
          const labels = recentSessions.map((s, i) => `Session ${i + 1}`);
          const scores = recentSessions.map(s => {
            return s.total_questions > 0 ? Math.round((s.score / s.total_questions) * 100) : 0;
          });
          
          // If less than 6 sessions, pad with zeros or use topic progress
          while (labels.length < 6) {
            labels.unshift(`Week ${labels.length + 1}`);
            scores.unshift(scores.length > 0 ? scores[0] : 0);
          }
          
          performanceChart = new Chart(performanceCtx.getContext('2d'), {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: 'Average Score (%)',
                data: scores,
                borderColor: '#5a67d8',
                backgroundColor: 'rgba(90, 103, 216, 0.1)',
                tension: 0.4,
                fill: true
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: true,
                  position: 'top'
                }
              },
              scales: {
                y: {
                  beginAtZero: false,
                  min: 0,
                  max: 100
                }
              }
            }
          });
        }

        // Subject Breakdown Chart - Group by category
        const subjectCtx = document.getElementById('subjectChart');
        if (subjectCtx) {
          const categoryScores = {};
          topicProgress.forEach(tp => {
            const topic = topics.find(t => t.id === tp.topic_id);
            if (topic && topic.category) {
              if (!categoryScores[topic.category]) {
                categoryScores[topic.category] = [];
              }
              categoryScores[topic.category].push(tp.best_score || 0);
            }
          });
          
          const categories = Object.keys(categoryScores);
          const avgScores = categories.map(cat => {
            const scores = categoryScores[cat];
            return scores.length > 0 ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length) : 0;
          });
          
          if (categories.length > 0) {
            subjectChart = new Chart(subjectCtx.getContext('2d'), {
              type: 'doughnut',
              data: {
                labels: categories,
                datasets: [{
                  data: avgScores,
                  backgroundColor: [
                    '#5a67d8',
                    '#667eea',
                    '#764ba2',
                    '#f093fb',
                    '#f5576c',
                    '#4facfe'
                  ]
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    position: 'bottom'
                  }
                }
              }
            });
          } else {
            // Show placeholder
            subjectCtx.getContext('2d').fillText('No data available yet', 10, 10);
          }
        }

        // Engagement Chart - Sessions by day of week
        const engagementCtx = document.getElementById('engagementChart');
        if (engagementCtx) {
          const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
          const dayCounts = [0, 0, 0, 0, 0, 0, 0];
          
          sessions.forEach(s => {
            if (s.completed_at) {
              const date = new Date(s.completed_at);
              const dayOfWeek = date.getDay();
              dayCounts[dayOfWeek]++;
            }
          });
          
          engagementChart = new Chart(engagementCtx.getContext('2d'), {
            type: 'bar',
            data: {
              labels: daysOfWeek,
              datasets: [{
                label: 'Sessions',
                data: dayCounts,
                backgroundColor: '#48bb78'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  display: false
                }
              },
              scales: {
                y: {
                  beginAtZero: true
                }
              }
            }
          });
        }
      } catch (error) {
        console.error('Error loading charts data:', error);
      }
    }

    // Current selected student / teacher lists and role
    let selectedStudent = null;
    let allStudents = [];
    let allTeachers = [];
    let currentUserRole = null;
    let teacherGrades = [];

    function updateGradeFiltersForTeacher() {
      if (!teacherGrades || teacherGrades.length === 0) return;

      const gradeFilterIds = ['gradeFilterTop', 'gradeFilterPage5'];
      gradeFilterIds.forEach(id => {
        const selectEl = document.getElementById(id);
        if (!selectEl) return;

        // Clear existing options
        selectEl.innerHTML = '';

        // "All My Grades" option
        const allOpt = document.createElement('option');
        allOpt.value = '';
        allOpt.textContent = 'All My Grades';
        selectEl.appendChild(allOpt);

        // One option per assigned grade
        const sortedGrades = [...teacherGrades].sort((a, b) => a - b);
        sortedGrades.forEach(g => {
          const opt = document.createElement('option');
          opt.value = String(g);
          opt.textContent = `Grade ${g}`;
          selectEl.appendChild(opt);
        });
      });
    }

    // Load students from database
    async function loadStudents() {
      try {
        const currentUser = await window.auth.getCurrentUser();
        if (!currentUser) {
          console.error('No user logged in');
          return;
        }

        const select = document.getElementById('childSelect');
        const profilesList = document.getElementById('profilesList');
        // Get grade filter from Home page or Students page (if present)
        const gradeFilterTopEl = document.getElementById('gradeFilterTop');
        const gradeFilterPageEl = document.getElementById('gradeFilterPage5');
        let gradeFilter = null;
        if (gradeFilterTopEl && gradeFilterTopEl.value !== '') {
          gradeFilter = gradeFilterTopEl.value;
        } else if (gradeFilterPageEl && gradeFilterPageEl.value !== '') {
          gradeFilter = gradeFilterPageEl.value;
        }
        // Keep both filters in sync
        if (gradeFilterTopEl && gradeFilter !== null) {
          gradeFilterTopEl.value = gradeFilter;
        }
        if (gradeFilterPageEl && gradeFilter !== null) {
          gradeFilterPageEl.value = gradeFilter;
        }
        
        // Clear existing options
        select.innerHTML = '<option value="">-- Select a student --</option>';
        profilesList.innerHTML = '';
        allStudents = [];

        // Get all students (combine children and direct students)
        let students = [];
        
        // Get children only for parents (legacy)
        if (currentUser.userType === 'parent') {
          if (window.electronAPI && window.electronAPI.invoke) {
            const childrenResult = await window.electronAPI.invoke('get-children', currentUser.id);
            if (childrenResult.success && childrenResult.children) {
              // Convert children to student format
              childrenResult.children.forEach(child => {
                // Apply grade filter if set
                if (!gradeFilter || gradeFilter === '' || child.grade === parseInt(gradeFilter)) {
                students.push({
                  id: child.id,
                  name: child.name,
                  grade: child.grade,
                  isChild: true
                });
                }
              });
            }
          }
        }
        
        // Get all students from users table with grade filter (admin) or scoped (teacher)
        if (window.electronAPI && window.electronAPI.invoke) {
          const allStudentsResult = await window.electronAPI.invoke('get-all-students', gradeFilter || null);
          if (allStudentsResult.success && allStudentsResult.students) {
            let fetchedStudents = allStudentsResult.students;

            // Extra safety: if this is a teacher, filter again on the frontend by their assigned grades
            if (currentUserRole === 'teacher' && teacherGrades && teacherGrades.length > 0) {
              const gradeSet = new Set(teacherGrades.map(g => parseInt(g)));
              fetchedStudents = fetchedStudents.filter(student => {
                const g = parseInt(student.grade || student.student_grade);
                return gradeSet.has(g);
              });
            }

            // Add students that aren't already in the list
            fetchedStudents.forEach(student => {
              const exists = students.find(s => s.id === student.id);
              if (!exists) {
                students.push({
                  id: student.id,
                  name: student.name || student.full_name,
                  grade: student.grade || student.student_grade,
                  email: student.email,
                  isChild: false
                });
              }
            });
          }
        }
        
        allStudents = students;
        
        // Add each student to dropdown and table
        const studentsEmptyState = document.getElementById('studentsEmptyState');
        let visibleCount = 0;

        students.forEach((student) => {
          // Dropdown option
          const option = document.createElement('option');
          option.value = student.id;
          option.textContent = `${student.name} (Grade ${student.grade || 'N/A'})`;
          select.appendChild(option);
          
          // Optional text search filter (admin only)
          const searchInput = document.getElementById('studentSearch');
          const searchTerm = searchInput ? searchInput.value.trim().toLowerCase() : '';
          if (searchTerm) {
            const haystack = `${student.name} ${student.email || ''}`.toLowerCase();
            if (!haystack.includes(searchTerm)) {
              return; // Skip in table
            }
          }

          visibleCount++;

          // Table row
          const tr = document.createElement('tr');
          const createdText = student.created_at ? new Date(student.created_at).toLocaleDateString() : '‚Äî';
          const typeLabel = currentUserRole === 'student' ? 'Self' : (student.isChild ? 'Linked' : 'Direct');

          tr.innerHTML = `
            <td>${student.name}</td>
            <td><span class="chip">Grade ${student.grade || 'N/A'}</span></td>
            <td>${student.email || '‚Äî'}</td>
            <td>${createdText}</td>
            <td><span class="status-pill muted">${typeLabel}</span></td>
          `;
          profilesList.appendChild(tr);
        });

        if (studentsEmptyState) {
          studentsEmptyState.style.display = visibleCount === 0 ? 'block' : 'none';
        }

        // Auto-select first student if available (ignores search)
        if (students.length > 0) {
          select.value = students[0].id;
          await loadChildData(students[0].id);
        }
      } catch (error) {
        console.error('Error loading students:', error);
      }
    }

    // Load teachers from database
    async function loadTeachers() {
      try {
        const currentUser = await window.auth.getCurrentUser();
        if (!currentUser) {
          console.error('No user logged in');
          return;
        }

        const teachersList = document.getElementById('teachersList');
        const teachersEmptyState = document.getElementById('teachersEmptyState');
        if (!teachersList) return;

        const gradeFilterEl = document.getElementById('teacherGradeFilter');
        const gradeFilter = gradeFilterEl ? gradeFilterEl.value : null;

        teachersList.innerHTML = '';
        allTeachers = [];

        if (window.electronAPI && window.electronAPI.invoke) {
          const result = await window.electronAPI.invoke('get-all-teachers', gradeFilter || null);
          if (result.success && result.teachers) {
            allTeachers = result.teachers;

            if (allTeachers.length === 0) {
              if (teachersEmptyState) teachersEmptyState.style.display = 'block';
              return;
            }

            if (teachersEmptyState) teachersEmptyState.style.display = 'none';

            allTeachers.forEach((teacher) => {
              const gradesText = teacher.grades
                ? teacher.grades.split(',').map(g => g.trim())
                : [];
              const createdText = teacher.created_at ? new Date(teacher.created_at).toLocaleDateString() : '‚Äî';

              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td>${teacher.name}</td>
                <td>${teacher.email}</td>
                <td>
                  ${gradesText.length ? gradesText.map(g => `<span class="chip">Grade ${g}</span>`).join(' ') : '<span class="status-pill muted">No grades set</span>'}
                </td>
                <td>${createdText}</td>
              `;
              teachersList.appendChild(tr);
            });
          } else {
            if (teachersEmptyState) {
              teachersEmptyState.textContent = 'Unable to load teachers.';
              teachersEmptyState.style.display = 'block';
            }
          }
        }
      } catch (error) {
        console.error('Error loading teachers:', error);
      }
    }

    // Load child data when selection changes
    async function loadChildData(studentId) {
      if (!studentId) {
        studentId = document.getElementById('childSelect').value;
      }
      
      if (!studentId) {
        selectedStudent = null;
        return;
      }

      try {
        // Get student info
        const student = allStudents.find(s => s.id == studentId);
        if (!student) return;
        
        selectedStudent = {
          id: parseInt(studentId),
          name: student.name,
          grade: student.grade
        };

        // Load all data for this student
        await loadStudentOverview(selectedStudent);
        await loadStudentAnalytics(selectedStudent);
        await loadStudentInsights(selectedStudent);
        await loadStudentRewards(selectedStudent);
        
        // Update page 1 (Home) if active
        if (document.getElementById('page1').classList.contains('active')) {
          await loadStudentOverview(selectedStudent);
        }
      } catch (error) {
        console.error('Error loading child data:', error);
      }
    }

    // Show add account modal
    function showAddStudentModal() {
      // Only admins can create student accounts
      if (currentUserRole === 'teacher') {
        return;
      }
      const modal = document.getElementById('addStudentModal');
      modal.classList.add('active');
      // Reset form
      document.getElementById('modalStudentName').value = '';
      document.getElementById('modalStudentEmail').value = '';
      document.getElementById('modalStudentPassword').value = '';
      const gradeSelect = document.getElementById('modalStudentGrade');
      if (currentUserRole === 'teacher' && teacherGrades && teacherGrades.length > 0) {
        // Rebuild options to only show teacher's grades
        gradeSelect.innerHTML = '';
        const defaultOpt = document.createElement('option');
        defaultOpt.value = '';
        defaultOpt.textContent = 'Select Grade';
        gradeSelect.appendChild(defaultOpt);

        const sortedGrades = [...teacherGrades].sort((a, b) => a - b);
        sortedGrades.forEach(g => {
          const opt = document.createElement('option');
          opt.value = String(g);
          opt.textContent = `Grade ${g}`;
          gradeSelect.appendChild(opt);
        });
      } else {
        gradeSelect.value = '';
      }
      document.getElementById('modalError').classList.remove('show');
      document.getElementById('modalError').textContent = '';
    }

    // Close add student modal
    function closeAddStudentModal() {
      const modal = document.getElementById('addStudentModal');
      modal.classList.remove('active');
    }

    // Show add teacher modal
    function showAddTeacherModal() {
      const modal = document.getElementById('addTeacherModal');
      modal.classList.add('active');
      document.getElementById('modalTeacherName').value = '';
      document.getElementById('modalTeacherEmail').value = '';
      document.getElementById('modalTeacherPassword').value = '';
      document.querySelectorAll('.teacher-grade-checkbox').forEach(cb => cb.checked = false);
      const err = document.getElementById('teacherModalError');
      err.classList.remove('show');
      err.textContent = '';
    }

    // Close add teacher modal
    function closeAddTeacherModal() {
      const modal = document.getElementById('addTeacherModal');
      modal.classList.remove('active');
    }

    // Toggle password visibility in modal
    function toggleModalPassword(inputId) {
      const input = document.getElementById(inputId);
      const toggle = input.nextElementSibling;
      if (input.type === 'password') {
        input.type = 'text';
        toggle.textContent = 'üëÅÔ∏è';
      } else {
        input.type = 'password';
        toggle.textContent = 'üôà';
      }
    }

    function showToast(message, isError = false) {
      const toast = document.getElementById('globalToast');
      const icon = document.getElementById('globalToastIcon');
      const msg = document.getElementById('globalToastMessage');
      if (!toast || !icon || !msg) return;

      msg.textContent = message;
      if (isError) {
        toast.classList.add('toast-error');
        icon.textContent = '‚ö†Ô∏è';
      } else {
        toast.classList.remove('toast-error');
        icon.textContent = '‚úÖ';
      }

      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // Handle add account form submission
    async function handleAddAccount(event) {
      event.preventDefault();
      
      const errorDiv = document.getElementById('modalError');
      errorDiv.classList.remove('show');
      errorDiv.textContent = '';

      // Get form values
      const userType = 'student';
      const fullName = document.getElementById('modalStudentName').value.trim();
      const email = document.getElementById('modalStudentEmail').value.trim();
      const password = document.getElementById('modalStudentPassword').value;
      const grade = document.getElementById('modalStudentGrade').value;

      // Validation
      if (!fullName) {
        errorDiv.textContent = 'Please enter full name';
        errorDiv.classList.add('show');
        return;
      }

      if (!email) {
        errorDiv.textContent = 'Please enter email';
        errorDiv.classList.add('show');
        return;
      }

      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        errorDiv.textContent = 'Invalid email format';
        errorDiv.classList.add('show');
        return;
      }

      if (!password) {
        errorDiv.textContent = 'Please enter password';
        errorDiv.classList.add('show');
        return;
      }

      if (password.length < 8) {
        errorDiv.textContent = 'Password must be at least 8 characters long';
        errorDiv.classList.add('show');
        return;
      }

      const hasUpperCase = /[A-Z]/.test(password);
      const hasLowerCase = /[a-z]/.test(password);
      const hasNumber = /[0-9]/.test(password);
      
      if (!hasUpperCase || !hasLowerCase || !hasNumber) {
        errorDiv.textContent = 'Password must contain uppercase, lowercase, and number';
        errorDiv.classList.add('show');
        return;
      }

      if (!grade) {
        errorDiv.textContent = 'Please select a grade for student';
        errorDiv.classList.add('show');
        return;
      }

      // Prepare user data
      const userData = {
        fullName: fullName,
        email: email,
        password: password,
        userType: userType,
        studentName: userType === 'student' ? fullName : null,
        studentGrade: userType === 'student' ? parseInt(grade) : null,
        studentCode: null
      };

      try {
        // Create the account using create-user handler
        if (window.electronAPI && window.electronAPI.invoke) {
          const result = await window.electronAPI.invoke('create-user', userData);
          
          if (result.success) {
            showToast('Student account created successfully!');
            await loadStudents();
            closeAddStudentModal();
          } else {
            errorDiv.textContent = result.error || `Failed to create ${userType} account. Please try again.`;
            errorDiv.style.color = '#fc8181';
            errorDiv.classList.add('show');
            showToast(errorDiv.textContent, true);
          }
        } else {
          errorDiv.textContent = 'System not available';
          errorDiv.style.color = '#fc8181';
          errorDiv.classList.add('show');
        }
      } catch (error) {
        errorDiv.textContent = 'An error occurred. Please try again.';
        errorDiv.style.color = '#fc8181';
        errorDiv.classList.add('show');
        console.error('Error creating account:', error);
        showToast('An error occurred while creating the account.', true);
      }
    }

    // Handle add teacher account form submission
    async function handleAddTeacherAccount(event) {
      event.preventDefault();

      const errorDiv = document.getElementById('teacherModalError');
      errorDiv.classList.remove('show');
      errorDiv.style.color = '#fc8181';
      errorDiv.textContent = '';

      const fullName = document.getElementById('modalTeacherName').value.trim();
      const email = document.getElementById('modalTeacherEmail').value.trim();
      const password = document.getElementById('modalTeacherPassword').value;
      const gradeCheckboxes = Array.from(document.querySelectorAll('.teacher-grade-checkbox:checked'));
      const teacherGrades = gradeCheckboxes.map(cb => parseInt(cb.value));

      if (!fullName) {
        errorDiv.textContent = 'Please enter full name';
        errorDiv.classList.add('show');
        return;
      }

      if (!email) {
        errorDiv.textContent = 'Please enter email';
        errorDiv.classList.add('show');
        return;
      }

      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        errorDiv.textContent = 'Invalid email format';
        errorDiv.classList.add('show');
        return;
      }

      if (!password) {
        errorDiv.textContent = 'Please enter password';
        errorDiv.classList.add('show');
        return;
      }

      if (password.length < 8) {
        errorDiv.textContent = 'Password must be at least 8 characters long';
        errorDiv.classList.add('show');
        return;
      }

      const hasUpperCase = /[A-Z]/.test(password);
      const hasLowerCase = /[a-z]/.test(password);
      const hasNumber = /[0-9]/.test(password);

      if (!hasUpperCase || !hasLowerCase || !hasNumber) {
        errorDiv.textContent = 'Password must contain uppercase, lowercase, and number';
        errorDiv.classList.add('show');
        return;
      }

      if (teacherGrades.length === 0) {
        errorDiv.textContent = 'Please select at least one grade level';
        errorDiv.classList.add('show');
        return;
      }

      const userData = {
        fullName: fullName,
        email: email,
        password: password,
        userType: 'teacher',
        studentName: null,
        studentGrade: null,
        studentCode: null,
        teacherGrades: teacherGrades
      };

      try {
        if (window.adminAPI && window.adminAPI.createUser) {
          const result = await window.adminAPI.createUser(userData);

          if (result.success) {
            errorDiv.textContent = 'Teacher account created successfully!';
            errorDiv.style.color = '#22c55e';
            errorDiv.classList.add('show');
            await loadTeachers();
            setTimeout(() => {
              closeAddTeacherModal();
              errorDiv.style.color = '#fc8181';
            }, 1500);
          } else {
            errorDiv.textContent = result.error || 'Failed to create teacher account. Please try again.';
            errorDiv.classList.add('show');
          }
        } else if (window.electronAPI && window.electronAPI.invoke) {
          // Fallback to generic invoke
          const result = await window.electronAPI.invoke('create-user', userData);
          if (result.success) {
            errorDiv.textContent = 'Teacher account created successfully!';
            errorDiv.style.color = '#22c55e';
            errorDiv.classList.add('show');
            await loadTeachers();
            setTimeout(() => {
              closeAddTeacherModal();
              errorDiv.style.color = '#fc8181';
            }, 1500);
          } else {
            errorDiv.textContent = result.error || 'Failed to create teacher account. Please try again.';
            errorDiv.classList.add('show');
          }
        } else {
          errorDiv.textContent = 'System not available';
          errorDiv.classList.add('show');
        }
      } catch (err) {
        console.error('Error creating teacher account:', err);
        errorDiv.textContent = 'An error occurred. Please try again.';
        errorDiv.classList.add('show');
      }
    }

    // Close modal when clicking outside
    document.addEventListener('click', function(event) {
      const modal = document.getElementById('addStudentModal');
      if (event.target === modal) {
        closeAddStudentModal();
      }
    });

    // Edit profile
    async function editProfile(studentId) {
      const student = allStudents.find(s => s.id == studentId);
      if (!student) return;
      
      const newGrade = prompt(`Edit grade for ${student.name}:\n(Current: Grade ${student.grade || 'N/A'})`, student.grade);
      if (newGrade && newGrade !== student.grade) {
        try {
          if (window.electronAPI && window.electronAPI.invoke) {
            const result = await window.electronAPI.invoke('update-student-grade', studentId, parseInt(newGrade));
            if (result.success) {
              alert('Grade updated successfully!');
              await loadStudents();
              // Reload data if this is the selected student
              if (selectedStudent && selectedStudent.id == studentId) {
                selectedStudent.grade = parseInt(newGrade);
                await loadChildData(studentId);
              }
            } else {
              alert('Error updating grade: ' + (result.error || 'Unknown error'));
            }
          }
        } catch (error) {
          console.error('Error updating grade:', error);
          alert('Error updating grade. Please try again.');
        }
      }
    }

    // Delete profile
    async function deleteProfile(studentId) {
      const student = allStudents.find(s => s.id == studentId);
      if (!student) return;
      
      if (!confirm(`Are you sure you want to delete ${student.name}'s profile? This action cannot be undone.`)) {
        return;
      }

      try {
        // Note: This would require a delete-user backend function
        // For now, we'll show a message
        alert('Student deletion feature requires backend implementation. This would permanently delete the student account and all their data.');
        
        // Remove from UI temporarily (would need backend function to actually delete)
        // await loadStudents(); // Reload to sync
      } catch (error) {
        console.error('Error deleting profile:', error);
        alert('Error deleting student profile. Please try again.');
      }
    }

    // Load student overview with real data
    async function loadStudentOverview(student) {
      if (!student) return;
      
      try {
        // Ensure student has a valid grade
        if (!student.grade || student.grade === 'N/A' || student.grade === null) {
          document.getElementById('studentOverview').innerHTML = `
            <p style="color: #fc8181; text-align: center; padding: 20px;">Please set a grade for ${student.name} to view their progress.</p>
          `;
          document.getElementById('aiSummaryContent').innerHTML = `
            <p style="text-align: center; opacity: 0.8;">Please set a grade for this student to view their personalized learning insights.</p>
          `;
          return;
        }
        
        // Load student progress
        const progressResult = await window.electronAPI.invoke('get-student-progress', student.id);
        const topicProgressResult = await window.electronAPI.invoke('get-student-topic-progress', student.id, student.grade);
        const sessionsResult = await window.electronAPI.invoke('get-practice-sessions', student.id);
        const curriculumResult = await window.electronAPI.invoke('get-curriculum-topics', student.grade);
        
        const progress = progressResult.success ? progressResult.progress : null;
        const topicProgress = topicProgressResult.success ? (topicProgressResult.progress || []) : [];
        const sessions = sessionsResult.success ? (sessionsResult.sessions || []) : [];
        const topics = curriculumResult.success ? (curriculumResult.topics || []) : [];
        
        // Debug logging (can be removed later)
        console.log('Student Overview Data:', {
          studentId: student.id,
          studentGrade: student.grade,
          topicProgress: topicProgress.length,
          sessions: sessions.length,
          topics: topics.length,
          progress: progress
        });
        
        // Calculate statistics - handle empty data gracefully
        const completedTopics = topicProgress.filter(p => 
          (p.completed === 1 || p.completed === true) || 
          (p.progress_percentage >= 100)
        ).length;
        const totalTopics = topics.length || 0;
        const overallProgress = totalTopics > 0 ? Math.round((completedTopics / totalTopics) * 100) : 0;
        
        // Calculate average score - try multiple sources
        let averageScore = 0;
        if (sessions.length > 0) {
          // Calculate from practice sessions
          const validSessions = sessions.filter(s => s.total_questions > 0);
          if (validSessions.length > 0) {
            const totalScore = validSessions.reduce((sum, s) => {
              const percentage = s.total_questions > 0 ? (s.score / s.total_questions) * 100 : 0;
              return sum + percentage;
            }, 0);
            averageScore = Math.round(totalScore / validSessions.length);
          }
        }
        
        // Fallback: Calculate from topic progress best scores
        if (averageScore === 0 && topicProgress.length > 0) {
          const topicsWithScores = topicProgress.filter(p => p.best_score && p.best_score > 0);
          if (topicsWithScores.length > 0) {
            const totalScore = topicsWithScores.reduce((sum, p) => sum + (p.best_score || 0), 0);
            averageScore = Math.round(totalScore / topicsWithScores.length);
          }
        }
        
        // Calculate time spent (estimate 2.5 minutes per session)
        // Only count sessions from the past 30 days for time spent
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        const recentSessionsForTime = sessions.filter(s => {
          if (!s.completed_at) return false;
          return new Date(s.completed_at) >= thirtyDaysAgo;
        });
        const timeSpentMinutes = recentSessionsForTime.length * 2.5;
        const timeSpentHours = Math.floor(timeSpentMinutes / 60);
        const timeSpentMins = Math.round(timeSpentMinutes % 60);
        const timeSpentDisplay = timeSpentHours > 0 ? `${timeSpentHours}h ${timeSpentMins}m` : `${Math.max(0, timeSpentMins)}m`;
        
        // Get streak days
        const streakDays = progress ? (progress.streak_days || 0) : 0;
        
        // Update overview stats
        const overviewDiv = document.getElementById('studentOverview');
        overviewDiv.innerHTML = `
          <div class="overview-stats">
            <div class="stat-item">
              <div class="stat-label">Overall Progress</div>
              <div class="stat-value">${overallProgress}%</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Lessons Completed</div>
              <div class="stat-value">${completedTopics}/${totalTopics}</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Average Score</div>
              <div class="stat-value">${averageScore}%</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Streak Days</div>
              <div class="stat-value">${streakDays}</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Time Spent</div>
              <div class="stat-value">${timeSpentDisplay}</div>
            </div>
            <div class="stat-item">
              <div class="stat-label">Practice Sessions</div>
              <div class="stat-value">${sessions.length}</div>
            </div>
          </div>
        `;
        
        // Generate AI Summary
        await loadAIInsights(student, progress, topicProgress, topics, sessions);
        
        // Generate alerts
        await generateAlerts(student, progress, topicProgress, sessions);
      } catch (error) {
        console.error('Error loading student overview:', error);
        document.getElementById('studentOverview').innerHTML = `
          <p style="color: #fc8181; text-align: center; padding: 20px;">Error loading student data. Please try again.</p>
        `;
      }
    }
    
    // Load AI insights using rule-based AI
    async function loadAIInsights(student, progress, topicProgress, topics, sessions) {
      const summaryDiv = document.getElementById('aiSummaryContent');
      if (!summaryDiv) return;
      
      try {
        // Calculate metrics first
        const completedTopics = topicProgress.filter(p => p.completed || p.progress_percentage >= 100).length;
        const totalTopics = topics.length;
        const avgScore = topicProgress.length > 0 
          ? Math.round(topicProgress.reduce((sum, p) => sum + (p.best_score || 0), 0) / topicProgress.length)
          : (sessions.length > 0 
            ? Math.round(sessions.reduce((sum, s) => {
                const percentage = s.total_questions > 0 ? (s.score / s.total_questions) * 100 : 0;
                return sum + percentage;
              }, 0) / sessions.length)
            : 0);
        
        const weakAreas = topicProgress.filter(p => (p.best_score || 0) < 70 && (p.progress_percentage || 0) > 0);
        const strongAreas = topicProgress.filter(p => (p.best_score || 0) >= 90);
        
        // Get recent sessions (last 7 days)
        const oneWeekAgo = new Date();
        oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
        const recentSessions = sessions.filter(s => {
          if (!s.completed_at) return false;
          return new Date(s.completed_at) >= oneWeekAgo;
        });
        
        // Try to get AI analysis
        let aiResult = null;
        try {
          aiResult = await window.electronAPI.invoke('analyze-student-performance', student.id, student.grade);
        } catch (error) {
          console.log('AI analysis not available, using rule-based insights');
        }
        
        // Generate performance summary
        let performanceSummary = '';
        if (recentSessions.length > 0) {
          const recentAvg = Math.round(recentSessions.reduce((sum, s) => {
            const percentage = s.total_questions > 0 ? (s.score / s.total_questions) * 100 : 0;
            return sum + percentage;
          }, 0) / recentSessions.length);
          performanceSummary = `${student.name} completed ${recentSessions.length} practice session(s) this week with an average score of ${recentAvg}%.`;
        } else if (sessions.length > 0) {
          performanceSummary = `${student.name} has completed ${sessions.length} total practice session(s) with an average score of ${avgScore}%.`;
        } else {
          performanceSummary = `${student.name} is just getting started! Completed ${completedTopics} of ${totalTopics} lessons.`;
        }
        
        // Generate learning insights
        let insights = '';
        if (weakAreas.length > 0 && strongAreas.length > 0) {
          insights = `Strong performance in ${strongAreas.length} topic(s), with ${weakAreas.length} area(s) needing more practice to reach mastery.`;
        } else if (weakAreas.length > 0) {
          insights = `Focus areas identified: ${weakAreas.length} topic(s) with scores below 70% need additional practice.`;
        } else if (strongAreas.length > 0) {
          insights = `Excellent work! ${strongAreas.length} topic(s) mastered with 90%+ scores.`;
        } else if (completedTopics > 0) {
          insights = `Making steady progress! ${completedTopics} lesson(s) completed.`;
        } else {
          insights = `Ready to begin learning! Start with the first lesson in the curriculum.`;
        }
        
        // Generate recommendations
        let recommendations = '';
        if (weakAreas.length > 0) {
          const weakTopicNames = weakAreas.map(w => {
            const topic = topics.find(t => t.id === w.topic_id);
            return topic ? topic.topic_title : 'Unknown Topic';
          }).slice(0, 3).join(', ');
          recommendations = `Review and practice: ${weakTopicNames}${weakAreas.length > 3 ? ` and ${weakAreas.length - 3} more` : ''}. Focus on understanding core concepts before moving forward.`;
        } else if (completedTopics < totalTopics && completedTopics > 0) {
          const nextTopic = topics.find(t => !topicProgress.find(p => p.topic_id === t.id && (p.completed || p.progress_percentage >= 100)));
          recommendations = nextTopic 
            ? `Great progress! Continue with: "${nextTopic.topic_title}". Keep practicing regularly to maintain momentum.`
            : `Excellent work! Consider reviewing previous topics to strengthen understanding.`;
        } else if (completedTopics === 0) {
          const firstTopic = topics[0];
          recommendations = firstTopic 
            ? `Start your learning journey with: "${firstTopic.topic_title}". Take your time and practice regularly.`
            : `Begin exploring the curriculum! Complete lessons to track your progress.`;
        } else {
          recommendations = `Amazing! All lessons completed. Continue practicing to maintain your skills and prepare for the next grade level!`;
        }
        
        // Use AI result if available and properly formatted, otherwise use generated insights
        let finalPerformance = performanceSummary;
        let finalInsights = insights;
        let finalRecommendations = recommendations;
        
        if (aiResult && aiResult.success && aiResult.analysis) {
          // Check different possible formats of AI response
          if (aiResult.analysis.summary) {
            finalPerformance = aiResult.analysis.summary;
          }
          if (aiResult.analysis.strengths && Array.isArray(aiResult.analysis.strengths) && aiResult.analysis.strengths.length > 0) {
            const strengths = aiResult.analysis.strengths.slice(0, 2).join(', ');
            const weaknesses = aiResult.analysis.weaknesses && Array.isArray(aiResult.analysis.weaknesses) && aiResult.analysis.weaknesses.length > 0
              ? aiResult.analysis.weaknesses.slice(0, 2).join(', ')
              : 'Continue practicing';
            finalInsights = `Strengths: ${strengths}. Areas to improve: ${weaknesses}.`;
          }
          if (aiResult.analysis.recommendedTopics && Array.isArray(aiResult.analysis.recommendedTopics) && aiResult.analysis.recommendedTopics.length > 0) {
            finalRecommendations = aiResult.analysis.recommendedTopics.slice(0, 2).join('. ') + '.';
          }
        }
        
        summaryDiv.innerHTML = `
          <div class="ai-summary-item">
            <strong>üìä This Week's Performance:</strong>
            <p>${finalPerformance}</p>
          </div>
          <div class="ai-summary-item">
            <strong>üí° Learning Insights:</strong>
            <p>${finalInsights}</p>
          </div>
          <div class="ai-summary-item">
            <strong>üéØ Recommendations:</strong>
            <p>${finalRecommendations}</p>
          </div>
        `;
      } catch (error) {
        console.error('Error loading AI insights:', error);
        // Fallback with basic info
        const completedTopics = topicProgress.filter(p => p.completed || p.progress_percentage >= 100).length;
        summaryDiv.innerHTML = `
          <div class="ai-summary-item">
            <strong>üìä Current Progress:</strong>
            <p>${student.name} has completed ${completedTopics} of ${topics.length} lessons.</p>
          </div>
          <div class="ai-summary-item">
            <strong>üí° Learning Insights:</strong>
            <p>Continue practicing to improve your skills!</p>
          </div>
          <div class="ai-summary-item">
            <strong>üéØ Recommendations:</strong>
            <p>Keep up the great work and practice regularly.</p>
          </div>
        `;
      }
    }
    
    // Generate alerts based on student activity
    async function generateAlerts(student, progress, topicProgress, sessions) {
      const alerts = [];
      
      // Check for low activity
      const today = new Date();
      const threeDaysAgo = new Date(today);
      threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);
      
      const recentSessions = sessions.filter(s => {
        if (!s.completed_at) return false;
        const sessionDate = new Date(s.completed_at);
        return sessionDate >= threeDaysAgo;
      });
      
      if (recentSessions.length === 0 && sessions.length > 0) {
        alerts.push({
          type: 'warning',
          icon: '‚ö†Ô∏è',
          title: 'Low Activity Alert',
          message: `${student.name} hasn't completed any lessons in the past 3 days. Consider encouraging them to continue learning.`,
          time: 'Recent'
        });
      }
      
      // Check for achievements (completed topics)
      const completedCount = topicProgress.filter(p => p.completed || p.progress_percentage >= 100).length;
      if (completedCount > 0 && completedCount % 5 === 0) {
        alerts.push({
          type: 'success',
          icon: '‚úÖ',
          title: 'Milestone Reached',
          message: `${student.name} completed ${completedCount} lessons! Great progress!`,
          time: 'Recent'
        });
      }
      
      // Check for topics needing attention
      const weakTopics = topicProgress.filter(p => (p.best_score || 0) < 70 && (p.progress_percentage || 0) > 0);
      if (weakTopics.length > 0) {
        alerts.push({
          type: 'info',
          icon: 'üí°',
          title: 'Topics Needing Practice',
          message: `${student.name} has ${weakTopics.length} topic(s) with scores below 70%. Additional practice is recommended.`,
          time: 'Recent'
        });
      }
      
      // Display alerts
      const alertsContainer = document.getElementById('alertsContainer');
      if (alerts.length > 0) {
        alertsContainer.innerHTML = alerts.map(alert => `
          <div class="alert-item ${alert.type}">
            <div class="alert-icon">${alert.icon}</div>
            <div class="alert-content">
              <div class="alert-title">${alert.title}</div>
              <div class="alert-message">${alert.message}</div>
              <div class="alert-time">${alert.time}</div>
            </div>
          </div>
        `).join('');
      } else {
        alertsContainer.innerHTML = `
          <p style="color: #666; text-align: center; padding: 20px;">No alerts at this time. ${student.name} is doing great! üéâ</p>
        `;
      }
    }
    
    // Load student analytics (charts)
    async function loadStudentAnalytics(student) {
      if (!student) return;
      
      // This will be called when page 2 is shown
      // Charts will be initialized with real data
    }
    
    // Load student insights (curriculum progress)
    async function loadStudentInsights(student) {
      if (!student) return;
      await loadCurriculumProgress(student);
    }
    
    // Load curriculum progress by category
    async function loadCurriculumProgress(student) {
      if (!student) return;
      
      try {
        const topicProgressResult = await window.electronAPI.invoke('get-student-topic-progress', student.id, student.grade);
        const curriculumResult = await window.electronAPI.invoke('get-curriculum-topics', student.grade);
        
        const topicProgress = topicProgressResult.success ? (topicProgressResult.progress || []) : [];
        const topics = curriculumResult.success ? (curriculumResult.topics || []) : [];
        
        // Group by category
        const categoryProgress = {};
        topics.forEach(topic => {
          const category = topic.category || 'Other';
          if (!categoryProgress[category]) {
            categoryProgress[category] = {
              topics: [],
              progress: []
            };
          }
          categoryProgress[category].topics.push(topic);
          
          const progress = topicProgress.find(tp => tp.topic_id === topic.id);
          categoryProgress[category].progress.push(progress || { progress_percentage: 0, completed: false });
        });
        
        // Build HTML
        const container = document.getElementById('curriculumContainer');
        const categoryHTML = Object.keys(categoryProgress).map(category => {
          const catData = categoryProgress[category];
          const completed = catData.progress.filter(p => p.completed || p.progress_percentage >= 100).length;
          const total = catData.topics.length;
          const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
          
          return `
            <div class="curriculum-item">
              <div class="curriculum-header">
                <div class="curriculum-title">${category}</div>
                <div style="font-weight: 600; color: #5a67d8;">${percentage}%</div>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${percentage}%"></div>
              </div>
              <div class="progress-text">${completed} of ${total} topics completed</div>
            </div>
          `;
        }).join('');
        
        container.innerHTML = categoryHTML || '<p style="color: #666; text-align: center; padding: 40px;">No curriculum data available.</p>';
      } catch (error) {
        console.error('Error loading curriculum progress:', error);
      }
    }
    
    // Load activity timeline
    async function loadActivityTimeline(student) {
      if (!student) return;
      
      try {
        const sessionsResult = await window.electronAPI.invoke('get-practice-sessions', student.id);
        const sessions = sessionsResult.success ? (sessionsResult.sessions || []) : [];
        const curriculumResult = await window.electronAPI.invoke('get-curriculum-topics', student.grade);
        const topics = curriculumResult.success ? (curriculumResult.topics || []) : [];
        
        const activityContainer = document.getElementById('activityContainer');
        
        if (sessions.length === 0) {
          activityContainer.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No activity recorded yet. Encourage the student to start practicing!</p>';
          return;
        }
        
        // Show last 10 sessions
        const recentSessions = sessions.slice(0, 10);
        
        activityContainer.innerHTML = recentSessions.map(session => {
          const date = session.completed_at ? new Date(session.completed_at) : new Date();
          const timeAgo = getTimeAgo(date);
          const topic = topics.find(t => t.id === session.topic_id);
          const topicName = topic ? topic.topic_title : 'Practice Session';
          const percentage = session.total_questions > 0 ? Math.round((session.score / session.total_questions) * 100) : 0;
          const duration = session.total_questions ? Math.round(session.total_questions * 0.25) : 0; // Estimate
          
          return `
            <div class="activity-item">
              <div class="activity-icon">üìñ</div>
              <div class="activity-details">
                <div class="activity-title">Completed: ${topicName}</div>
                <div class="activity-time">${timeAgo}</div>
              </div>
              <div class="activity-duration">${percentage}%</div>
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('Error loading activity timeline:', error);
      }
    }
    
    // Helper function to calculate time ago
    function getTimeAgo(date) {
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);
      
      if (diffMins < 60) {
        return diffMins <= 1 ? 'Just now' : `${diffMins} minutes ago`;
      } else if (diffHours < 24) {
        return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
      } else if (diffDays < 7) {
        return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
      } else {
        return date.toLocaleDateString();
      }
    }
    
    // Load student rewards
    async function loadStudentRewards(student) {
      if (!student) return;
      
      try {
        const progressResult = await window.electronAPI.invoke('get-student-progress', student.id);
        const topicProgressResult = await window.electronAPI.invoke('get-student-topic-progress', student.id, student.grade);
        
        const progress = progressResult.success ? progressResult.progress : null;
        const topicProgress = topicProgressResult.success ? (topicProgressResult.progress || []) : [];
        
        const coins = progress ? (progress.coins || 0) : 0;
        const completedTopics = topicProgress.filter(p => p.completed || p.progress_percentage >= 100).length;
        const streakDays = progress ? (progress.streak_days || 0) : 0;
        
        // Determine badges earned
        const badges = [];
        if (completedTopics >= 10) badges.push({ icon: 'üìö', name: 'Bookworm', earned: true });
        if (streakDays >= 7) badges.push({ icon: 'üî•', name: 'Hot Streak', earned: true });
        
        const perfectScores = topicProgress.filter(p => (p.best_score || 0) === 100).length;
        if (perfectScores > 0) badges.push({ icon: 'üéØ', name: 'Perfect Score', earned: true });
        
        const highScores = topicProgress.filter(p => (p.best_score || 0) >= 90).length;
        if (highScores >= 5) badges.push({ icon: '‚≠ê', name: 'Star Student', earned: true });
        
        // Update rewards display
        const rewardsDiv = document.getElementById('rewardsDisplay');
        rewardsDiv.innerHTML = `
          <div class="points-display">${coins} Coins</div>
          <h4>Badges Earned (${badges.filter(b => b.earned).length})</h4>
          <div class="rewards-grid">
            ${badges.map(badge => `
              <div class="reward-badge ${badge.earned ? 'earned' : ''}">
                <div class="reward-icon">${badge.icon}</div>
                <div class="reward-name">${badge.name}</div>
              </div>
            `).join('')}
            ${badges.length === 0 ? '<p style="grid-column: 1/-1; text-align: center; color: #666; padding: 20px;">Keep practicing to earn badges! üèÜ</p>' : ''}
          </div>
          <div style="margin-top: 20px; padding: 15px; background: #f7fafc; border-radius: 10px;">
            <div style="display: flex; justify-content: space-around; text-align: center;">
              <div>
                <div style="font-size: 24px; font-weight: 700; color: #5a67d8;">${completedTopics}</div>
                <div style="font-size: 12px; color: #666;">Lessons Completed</div>
              </div>
              <div>
                <div style="font-size: 24px; font-weight: 700; color: #5a67d8;">${streakDays}</div>
                <div style="font-size: 12px; color: #666;">Day Streak</div>
              </div>
            </div>
          </div>
        `;
      } catch (error) {
        console.error('Error loading rewards:', error);
        document.getElementById('rewardsDisplay').innerHTML = `
          <p style="color: #fc8181; text-align: center; padding: 20px;">Error loading rewards data.</p>
        `;
      }
    }
    
    // Load remedial and suggested activities
    async function loadRemedialActivities(student) {
      if (!student) return;
      
      try {
        const topicProgressResult = await window.electronAPI.invoke('get-student-topic-progress', student.id, student.grade);
        const curriculumResult = await window.electronAPI.invoke('get-curriculum-topics', student.grade);
        
        const topicProgress = topicProgressResult.success ? (topicProgressResult.progress || []) : [];
        const topics = curriculumResult.success ? (curriculumResult.topics || []) : [];
        
        // Find topics needing remediation (< 70%)
        const weakTopics = topicProgress
          .filter(tp => {
            const score = tp.best_score || 0;
            return score > 0 && score < 70;
          })
          .map(tp => {
            const topic = topics.find(t => t.id === tp.topic_id);
            return { progress: tp, topic: topic };
          })
          .filter(item => item.topic)
          .slice(0, 3);
        
        // Find completed topics (for suggested next steps)
        const strongTopics = topicProgress
          .filter(tp => (tp.best_score || 0) >= 90)
          .map(tp => {
            const topic = topics.find(t => t.id === tp.topic_id);
            return { progress: tp, topic: topic };
          })
          .filter(item => item.topic);
        
        // Find next uncompleted topics
        const nextTopics = topics
          .filter(t => !topicProgress.find(tp => tp.topic_id === t.id && (tp.completed || tp.progress_percentage >= 100)))
          .slice(0, 3);
        
        // Build remedial activities
        const remedialContainer = document.getElementById('remedialContainer');
        if (weakTopics.length > 0) {
          remedialContainer.innerHTML = weakTopics.map(item => `
            <div class="activity-card">
              <div class="activity-title">Review: ${item.topic.topic_title}</div>
              <div class="activity-description">Score: ${item.progress.best_score || 0}%. Additional practice recommended to improve understanding.</div>
              <button class="activity-btn" onclick="alert('Practice feature coming soon!')">Start Practice</button>
            </div>
          `).join('');
        } else {
          remedialContainer.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">Great job! No topics need remediation. Keep up the excellent work! üéâ</p>';
        }
        
        // Build suggested activities
        const suggestedContainer = document.getElementById('suggestedContainer');
        if (nextTopics.length > 0) {
          suggestedContainer.innerHTML = nextTopics.map(topic => `
            <div class="activity-card suggested">
              <div class="activity-title">${topic.topic_title}</div>
              <div class="activity-description">${topic.learning_outcome}</div>
              <button class="activity-btn" onclick="alert('Activity feature coming soon!')">Start Activity</button>
            </div>
          `).join('');
        } else {
          suggestedContainer.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">All topics completed! Excellent progress! üèÜ</p>';
        }
      } catch (error) {
        console.error('Error loading activities:', error);
      }
    }

    // Load current user and update UI
    async function loadCurrentUser() {
      try {
        if (window.auth && window.auth.getCurrentUser) {
          const user = await window.auth.getCurrentUser();
          if (user) {
            currentUserRole = user.userType || user.user_type || null;
            const accountNameElement = document.getElementById('accountName');
            if (accountNameElement) {
              accountNameElement.textContent = user.fullName || 'User';
            }

            // Role-based UI: limit what teachers can see
            const userType = user.userType || user.user_type;
            if (userType === 'teacher') {
              // Hide Teachers management page (admin-only)
              const teachersNav = document.querySelector('.sidebar .nav-item:nth-child(6)');
              if (teachersNav) {
                teachersNav.style.display = 'none';
              }

              // Hide Create Student Account button for teachers
              const createStudentBtn1 = document.getElementById('createStudentAccountBtn');
              if (createStudentBtn1) {
                createStudentBtn1.style.display = 'none';
              }
              const createStudentBtn2 = document.getElementById('topCreateStudentBtn');
              if (createStudentBtn2) {
                createStudentBtn2.style.display = 'none';
              }

              // Load teacher grades to scope filters
              if (window.electronAPI && window.electronAPI.invoke) {
                try {
                  const result = await window.electronAPI.invoke('get-teacher-grades');
                  if (result.success && Array.isArray(result.grades)) {
                    teacherGrades = result.grades;
                    updateGradeFiltersForTeacher();
                  }
                } catch (e) {
                  console.error('Error loading teacher grades:', e);
                }
              }
            }
          } else {
            // No user logged in, redirect to auth
            window.navigateToAuth();
          }
        }
      } catch (error) {
        console.error('Error loading current user:', error);
        // If error, redirect to auth page
        window.navigateToAuth();
      }
    }

    // Handle logout
    async function handleLogout() {
      try {
        if (window.auth && window.auth.logout) {
          await window.auth.logout();
        }
        window.navigateToAuth();
      } catch (error) {
        console.error('Error logging out:', error);
        window.navigateToAuth();
      }
    }

    // Initialize when page loads
    window.addEventListener('DOMContentLoaded', async function() {
      // Load current user
      await loadCurrentUser();
      
      // Always load students on dashboard load (but scoped by role)
      await loadStudents();
      
      // Initialize charts if on page 2
      if (document.getElementById('page2').classList.contains('active') && selectedStudent) {
        setTimeout(() => {
          initCharts();
          loadActivityTimeline(selectedStudent);
        }, 100);
      }
    });
  </script>
  <script src="render.js"></script>
</body>
</html>
